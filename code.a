#rom.org $8160
inline install_raster_irq(raster_line, offset)
{
    LDA raster_line
    LDX #lo(offset)
    LDY #hi(offset) 
    JSR $8CBA
}

function noreturn start()
{
    SEI

    JSR $1048
    TXS

    LDA #$7F
    STA $DC0D

    LDA #$01
    STA $D01A

    LDA $90A2
    PHA
    if (equal) 
    {
        INC $90A2
        JSR $1048
    }
    JSR $8D0D

    install_raster_irq(#$B2, $8B85)
    CLI

    LDX #$40
    LDA #$00
    do {
        STA $033F,X
        STA $037F,X
        STA $02BF,X
        DEX
    } while (not equal)

    LDX #$0D
    STX $07F8
    INX
    STX $07F9
    LDA #$0B
    STA $07FA

    LDX #$00
    TXA
    do {
        STA $0C00,X
        STA $0D00,X
        STA $0E00,X
        STA $0EE8,X

        INX
    } while (not equal)

    LDX #$28
    LDA #$01
    do {
        STA $0D8F,X
        DEX
    } while (not equal)

    JSR $8DAA
    JSR $8D1F

    STX $50
    STX $51
    STX $91CD

    LDA #$0F
    STA $3D
    STA $3E
    JSR $8824

    STX $D020
    STX $D021

    LDX #$10
    LDA #$08
    JSR $8CC9

    LDX #$03
    LDA #$02
    JSR $8CD1

    LDX #$02
    LDA #$0E
    JSR $8CD1

    do {
        LDA $6DD1,X
        STA $D800,X
        LDA $6ED1,X
        STA $D900,X
        LDA $6F51,X
        STA $D980,X
        INX
    } while (not equal)

    JSR $8D18

loc820b:
    LDX #$20
    do {
        LDA $6C10,X
        STA $06AB,X
        LDA $6C30,X
        STA $06D3,X
        LDA $6C50,X
        STA $06FB,X
        LDA $6C70,X
        STA $0723,X
        LDA $6C90,X
        STA $0773,X
        LDA $6CB0,X
        STA $079B,X

        DEX
    } while (not equal)

    STX $37
    LDA #$05
    STA $38
loc823a:
    LDY #$10
    do {
        JSR $84E4
        LDA $8F48,Y
        JSR $8DCF
        DEY
    } while (not equal)

    JSR $8DBE
    if (equal) 
    {
        do {
            JSR $84E4
            LDA $8F49,Y
            JSR $8DCF
            INY
            CPY #$10
        } while (no carry)

        JSR $8DBE
        if (equal) 
        {
            LDY $37
            do {
                LDA $6CD1,Y
                STA $0774,X
                LDA $6CF1,Y
                STA $079C,X
                INX
                INY
                CPX #$20
            } while (no carry)

            LDA $37
            ADC #$3F
            STA $37
            DEC $38
            BNE loc823a
            JMP loc820b
        }
    }

    JSR $8D0D
    PLA
    STA $90A2
    if (zero) {
        JSR $8DDB
    }
    JSR $8CB4
    JSR $8DAA

    LDX #$0C
    do {
        LDA #$41
        STA $06B5,X
        DEX
        LDA #$40
        STA $06B5,X
        DEX
    } while (not zero)

    TXA
    LDX #$2D
    do {
        STA $37,X
        DEX
    } while (not zero)

    DEC $64
    INX
    STX $48
    STX $45
    LDA #$63
    STA $4D
    STA $4C
    LDA #$DF
    STA $65
    LDA #$08
    STA $3D
    LDA #$54
    STA $40

    LDA #$37
    STA $41

    JSR $87DD
    JSR $8D18
loc82ce:
    JSR $8995
    LDA $57
    if (zero) {
        DEC $57
        JSR $8824
    }
    LDX #$02
    JSR $84E6
    JSR $8D6F
    CLC
    TYA
    ADC #$40
    TAY
    JSR $8D84

    if (not negative) { 
        JSR f_8371
    }

    STA $3A
    JSR $84FF
    JSR $8C86

    BEQ loc835c

    CPX #$3B
    BNE loc831f

    JSR $84E4
    LDA $90A2
    BNE loc830e

    INC $90A2
    JSR $1048
    JMP $8316
loc830e:
    LDA #$00
    STA $90A2
    JSR $8DDB

    do {
        DEC $63
        JSR $8C86
    } while (not zero)
    BEQ loc82ce

loc831f:
    LDA $63

    CMP #$3D
    BNE loc834c
loc8325:
    JSR $8490
    ORA #$09
    STA $43
    STA $62
    LDA #$07
    STA $3B
loc8332:
    JSR $8995
    LDX $3B
    LDY $8FEB,X
    
loc833a:
    JSR $84E4
    LDA $46
    BNE loc834c

    DEY
    BNE loc833a
    INC $43
    DEC $3B
    BNE loc8332
    BEQ loc8325
loc834c:
    LDX #$00
    STX $62
    CMP #$3C
    BEQ loc8364
    CMP #$3A
    BNE loc835C
    DEX
    JSR $8694
loc835c:
    LDA $4D
    BEQ loc8364
    LDA $4C

    BNE loc8367
loc8364:
    JSR $8627
loc8367:
    DEC $63
    LDX $46
    JSR $83D9

    JMP loc82ce
}

function f_8371()
{
    LDA #$00
    STA $42
    do {
        JSR $8D6A
        LDA $45

        if (not zero) {
            LDY $42
            LDA $8FB0,Y
        }

        if (carry) {
            JSR $8456
            JMP $838C
        }

        JSR $84A8
        LDY $42
        LDA $8FB8,Y
        JSR $8D39
        JSR $8490
        ORA #$15
        STA $43
        JSR $8D6F
        CLC
        TYA
        ADC #$40
        TAY
        JSR $8D84
        BMI loc83BD

        JSR $8995
        LDA $42
        CMP #$08
        if (no carry) {
            INC $42
            LDX #$02
            JSR $84E6
        }

        JSR $84E4
    } while (zero) 

loc83bd:
    JSR $8D30
    JSR $8995
    JSR $8E0F

    do {
        JSR $8995
        LDX #$05
        JSR $84E6
        INC $43
        LDA $43
        AND #$1F
        CMP #$17
    } while (no carry)
}

#ifdef 0
function f_84e4()
{
    LDX #$01
    do {
        do {
            BIT $D011
        } while (negative)

        do {
            BIT $D011
        } while (positive)
        DEX
    while (not zero)
}
#endif

//#incbin "code.bin",407
#incbin "code.bin",633
